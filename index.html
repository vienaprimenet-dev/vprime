<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa Interativo Avançado - Leaflet</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<style>
  #map { height: 100vh; }
  .filter-box {
    position: absolute;
    top: 10px;
    left: 50px;
    z-index: 1000;
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-family: Arial, sans-serif;
    box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
  }
  .filter-box button { margin-left: 5px; }
</style>
</head>
<body>

<div class="filter-box">
  <label>Filtrar por tipo:</label>
  <select id="filter">
    <option value="Todos">Todos</option>
    <option value="Cliente VIP">Cliente VIP</option>
    <option value="Cliente Regular">Cliente Regular</option>
  </select>
  <button id="btnLimpar">Limpar tudo</button>
  <button id="btnExport">Exportar CSV</button>
  <button id="btnMedir">Medir Distância</button>
  <span id="count"></span>
  <span id="distances"></span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

<script>
const SHEET_ID = "1_fuH8vWVLWqYb3H3PD6OB7iNuq_gT_s5wOEb01POuaw"; // ID da planilha Google Sheets
const SHEET_URL = `https://docs.google.com/spreadsheets/d/1_fuH8vWVLWqYb3H3PD6OB7iNuq_gT_s5wOEb01POuaw/gviz/tq?tqx=out:csv`;

const map = L.map('map').setView([-23.55052, -46.633308], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let markerGroup = L.featureGroup().addTo(map);
let currentCircle = null;

// Medições de distância
let measurementLayer = L.featureGroup().addTo(map);
let measurementPoints = [];
let distances = [];
let medirDistancia = false;

// --- Funções ---
function loadData(filter = "Todos") {
    markerGroup.clearLayers();
    markers = [];

    Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
            results.data.forEach(row => {
                if(row.Latitude && row.Longitude){
                    if(filter !== "Todos" && row.InfoExtra !== filter) return;

                    const marker = L.marker([parseFloat(row.Latitude), parseFloat(row.Longitude)], {data: row, selected:false})
                        .bindPopup(`<b>${row.Nome}</b><br>${row.InfoExtra}`)
                        .bindTooltip(row.Nome, {permanent:false, direction:"top"})
                        .on('click', function(){
                            if(!medirDistancia) return;
                            measurementPoints.push(this.getLatLng());
                            if(measurementPoints.length > 1){
                                const last = measurementPoints[measurementPoints.length-1];
                                const prev = measurementPoints[measurementPoints.length-2];
                                const dist = prev.distanceTo(last);
                                const distText = dist>=1000 ? (dist/1000).toFixed(2)+" km" : Math.round(dist)+" m";

                                const line = L.polyline([prev,last], {color:'blue'}).addTo(measurementLayer);

                                // Label no meio
                                const midLat = (prev.lat + last.lat)/2;
                                const midLng = (prev.lng + last.lng)/2;
                                L.marker([midLat, midLng], {
                                    icon: L.divIcon({
                                        className:'distance-label',
                                        html:`<div style="background:white;padding:2px 4px;border:1px solid blue;border-radius:3px;">${distText}</div>`
                                    }),
                                    interactive:false
                                }).addTo(measurementLayer);

                                distances.push(dist);
                                const totalDist = distances.reduce((a,b)=>a+b,0);
                                const totalText = totalDist>=1000 ? (totalDist/1000).toFixed(2)+" km" : Math.round(totalDist)+" m";
                                document.getElementById("distances").innerText = ` | Distância total do círculo: ${totalText}`;
                            }
                        });
                    markerGroup.addLayer(marker);
                    markers.push(marker);
                }
            });
            updateCircleSelection();
        }
    });
}

function updateCircleSelection(){
    if(!currentCircle){
        document.getElementById("count").innerText = ` | Pontos: ${markers.length}`;
        return;
    }
    const center = currentCircle.getLatLng();
    const radius = currentCircle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.getLatLng()) <= radius);

    // Atualiza seleção e cor
    markers.forEach(m => {
        if(selecionados.includes(m)){
            m.selected = true;
            m.setIcon(L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize:[32,32]}));
        } else {
            m.selected = false;
            m.setIcon(new L.Icon.Default());
        }
    });

   // Remove tooltip antigo
if(currentCircle.tooltipMarker) map.removeLayer(currentCircle.tooltipMarker);

const tooltipLatLng = L.latLng(currentCircle.getBounds().getNorth(), currentCircle.getBounds().getEast());
currentCircle.tooltipMarker = L.marker(tooltipLatLng, {
    icon: L.divIcon({className:'circle-tooltip', html:`<div style="background:white;padding:4px;border:1px solid gray;border-radius:4px;">Pontos no raio: ${selecionados.length}<br>${nomes}</div>`})
}).addTo(map);

    // Zoom automático
    if(selecionados.length>0){
        const group = L.featureGroup(selecionados);
        map.fitBounds(group.getBounds().pad(0.2));
    }

    document.getElementById("count").innerText = ` | Pontos no raio: ${selecionados.length}`;
}

// --- Botões ---
document.getElementById("btnLimpar").addEventListener("click", ()=>{
    if(currentCircle){ map.removeLayer(currentCircle); currentCircle=null; }
    markerGroup.eachLayer(m => m.setIcon(new L.Icon.Default()));
    measurementLayer.clearLayers();
    measurementPoints=[];
    distances=[];
    document.getElementById("distances").innerText="";
    medirDistancia=false;
    updateCircleSelection();
});

document.getElementById("btnExport").addEventListener("click", ()=>{
    if(!currentCircle) return alert("Desenhe um raio primeiro!");
    const center = currentCircle.getLatLng();
    const radius = currentCircle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.getLatLng()) <= radius);
    if(selecionados.length===0) return alert("Nenhum ponto selecionado!");
    const csvContent = "data:text/csv;charset=utf-8," + 
        selecionados.map(e => Object.values(e.data).join(",")).join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download","pontos_selecionados.csv");
    document.body.appendChild(link);
    link.click();
});

document.getElementById("btnMedir").addEventListener("click", ()=>{
    medirDistancia = !medirDistancia;
    measurementPoints = [];
    distances=[];
    measurementLayer.clearLayers();
    document.getElementById("distances").innerText="";
    if(medirDistancia) alert("Clique nos marcadores para medir a distância entre eles.");
});

// --- Controle de desenho ---
const drawControl = new L.Control.Draw({
    draw: {
        marker:false, polygon:false, polyline:false, rectangle:false, circle:true, circlemarker:false
    },
    edit: { featureGroup: new L.FeatureGroup().addTo(map) }
});
map.addControl(drawControl);

// --- Evento ao criar círculo ---
map.on(L.Draw.Event.CREATED, function(e){
    if(currentCircle) map.removeLayer(currentCircle);
    currentCircle = e.layer;
    currentCircle.addTo(map);
    currentCircle.on('edit', updateCircleSelection);
    updateCircleSelection();
});

// --- Filtro ---
document.getElementById("filter").addEventListener("change", function(){
    loadData(this.value);
});

// Carrega inicialmente
loadData();
</script>

</body>
</html>
