<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa Interativo Avan√ßado - Leaflet</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<style>
  #map { height: 100vh; }
  .filter-box {
    position: absolute;
    top: 10px;
    left: 50px;
    z-index: 1000;
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-family: Arial, sans-serif;
    box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
  }
  .leaflet-tooltip.outside {
    background: white;
    border: 1px solid #666;
    padding: 2px 6px;
    font-size: 12px;
    border-radius: 4px;
  }
</style>
</head>
<body>

<div class="filter-box">
  <label>Filtrar por tipo:</label>
  <select id="filter">
    <option value="Todos">Todos</option>
    <option value="Cliente VIP">Cliente VIP</option>
    <option value="Cliente Regular">Cliente Regular</option>
  </select>
  <span id="count"></span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

<script>
const SHEET_ID = "1_fuH8vWVLWqYb3H3PD6OB7iNuq_gT_s5wOEb01POuaw";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

const map = L.map('map').setView([-23.55052, -46.633308], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let markerGroup = L.featureGroup().addTo(map);
let currentCircle = null;
let currentPolyline = null;
let tempPoints = [];
let distanceMarkers = [];

// Carregar dados da planilha
function loadData(filter = "Todos") {
    markerGroup.clearLayers();
    markers = [];

    Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
            results.data.forEach(row => {
                if (row.Latitude && row.Longitude) {
                    if (filter !== "Todos" && row.InfoExtra !== filter) return;

                    const marker = L.marker([parseFloat(row.Latitude), parseFloat(row.Longitude)])
                        .bindPopup(`<b>${row.Nome}</b><br>${row.InfoExtra}`)
                        .bindTooltip(row.Nome, {permanent: false, direction: "top"});

                    marker.on("click", () => {
                        if (measuring) {
                            tempPoints.push(marker.getLatLng());
                            if (tempPoints.length >= 2) {
                                drawPolyline();
                            }
                        }
                    });

                    markerGroup.addLayer(marker);
                    markers.push(marker);
                }
            });
            updateCount();
        }
    });
}

// Atualiza contagem de pontos no raio
function updateCount() {
    if (!currentCircle) {
        document.getElementById("count").innerText = ` | Pontos: ${markers.length}`;
        return;
    }
    const center = currentCircle.getLatLng();
    const radius = currentCircle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.getLatLng()) <= radius);
    document.getElementById("count").innerText = ` | Pontos no raio: ${selecionados.length}`;

    // Tooltip fora do c√≠rculo
    const tooltipLatLng = L.latLng(center.lat + (radius / 111320), center.lng); // desloca latitude para cima
    if (currentCircle.tooltip) {
        map.removeLayer(currentCircle.tooltip);
    }
    currentCircle.tooltip = L.tooltip({
        permanent: true,
        direction: "top",
        className: "outside"
    })
    .setLatLng(tooltipLatLng)
    .setContent(`Pontos no raio: ${selecionados.length}`)
    .addTo(map);
}

// Controle de desenho do c√≠rculo
const drawControl = new L.Control.Draw({
    draw: {
        marker: false,
        polygon: false,
        polyline: false,
        rectangle: false,
        circle: true,
        circlemarker: false
    },
    edit: {
        featureGroup: new L.FeatureGroup().addTo(map)
    }
});
map.addControl(drawControl);

map.on(L.Draw.Event.CREATED, function(e) {
    if (currentCircle) map.removeLayer(currentCircle);
    currentCircle = e.layer;
    currentCircle.addTo(map);
    currentCircle.on('edit', updateCount);
    updateCount();
});

// --- Fun√ß√£o de medi√ß√£o com bot√£o ---
let measuring = false;

const measureBtn = L.control({position: 'topleft'});
measureBtn.onAdd = function() {
    const btn = L.DomUtil.create('button', '');
    btn.innerHTML = 'üìè Medir';
    btn.style.background = 'white';
    btn.style.padding = '5px';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
        measuring = !measuring;
        tempPoints = [];
        clearPolyline();
        btn.style.background = measuring ? '#ccc' : 'white';
    };
    return btn;
};
measureBtn.addTo(map);

function drawPolyline() {
    clearPolyline();
    currentPolyline = L.polyline(tempPoints, {color: 'blue'}).addTo(map);

    for (let i = 1; i < tempPoints.length; i++) {
        const dist = tempPoints[i-1].distanceTo(tempPoints[i]);
        const distText = dist >= 1000 ? (dist/1000).toFixed(2) + " km" : dist.toFixed(0) + " m";
        const midPoint = L.latLng(
            (tempPoints[i-1].lat + tempPoints[i].lat) / 2,
            (tempPoints[i-1].lng + tempPoints[i].lng) / 2
        );
        const label = L.tooltip({
            permanent: true,
            direction: "center",
            className: "outside"
        })
        .setLatLng(midPoint)
        .setContent(distText)
        .addTo(map);
        distanceMarkers.push(label);
    }
}

function clearPolyline() {
    if (currentPolyline) map.removeLayer(currentPolyline);
    distanceMarkers.forEach(l => map.removeLayer(l));
    distanceMarkers = [];
}

// Evento para mudar filtro
document.getElementById("filter").addEventListener("change", function() {
    loadData(this.value);
});

// Carrega dados inicialmente
loadData();
</script>

</body>
</html>
