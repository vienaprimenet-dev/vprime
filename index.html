<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapa Interativo Avançado</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="filter-box">
  <label>Filtrar por tipo:</label>
  <select id="filter">
    <option value="Todos">Todos</option>
    <option value="Norte">Norte</option>
    <option value="Oeste">Oeste</option>
  </select>
  <button id="drawCircle">Desenhar Círculo</button>
  <button id="measureLine">Medir Distância</button>
  <button id="clearAll">Limpar Tudo</button>
  <button id="exportAllCSV">Exportar Todos</button>
  <span id="count"></span>
</div>

<div class="circle-controls" id="circleControls" style="display: none;">
  <h4>Círculos Ativos</h4>
  <div id="circlesList"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1T4op3w-S78vWsekwqexPeUNZM4opI-zMRpkYJUaSXyU/export?format=csv";

const map = L.map('map').setView([-23.55052, -46.633308], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let markerGroup = L.featureGroup().addTo(map);
let circles = [];
let drawnItems = new L.FeatureGroup().addTo(map);
let measureMode = false;
let tempLine = null;
let measurePoints = [];
let totalDistance = 0;

// Inicializar controle de desenho
const drawControl = new L.Control.Draw({
    draw: {
        polyline: false,
        polygon: false,
        rectangle: false,
        circle: true,
        marker: false,
        circlemarker: false
    },
    edit: {
        featureGroup: drawnItems,
        remove: false
    }
}).addTo(map);

// Função para criar ícone de marcador dinâmico baseado no zoom
function createDotIcon(zoom, isSelected = false) {
    const size = zoom > 10 ? 8 : zoom > 7 ? 6 : 4;
    return L.divIcon({
        className: `dot-marker ${isSelected ? 'selected-marker' : ''}`,
        html: `<div style="width: ${size}px; height: ${size}px;"></div>`,
        iconSize: [size, size],
        iconAnchor: [size / 2, size / 2]
    });
}

// Função para atualizar ícones dos marcadores com base no zoom
function updateMarkerIcons() {
    const zoom = map.getZoom();
    markers.forEach(m => {
        const isSelected = m.marker.options.isSelected || false;
        m.marker.setIcon(createDotIcon(zoom, isSelected));
    });
}

// Carregar dados da planilha
function loadData(filter = "Todos") {
    markerGroup.clearLayers();
    markers = [];
    Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
            results.data.forEach(row => {
                if (row.Latitude && row.Longitude) {
                    if (filter !== "Todos" && row.Regional !== filter) return;

                    const marker = L.marker([parseFloat(row.Latitude), parseFloat(row.Longitude)], {
                        customId: row.Nome,
                        icon: createDotIcon(map.getZoom())
                    });
                    
                    const popupContent = `<b>${row.Nome}</b><br>${row.Regional}`;
                    marker.bindPopup(popupContent);
                    
                    marker.on('click', function(e) {
                        map.closePopup();
                        this.openPopup();
                        if (measureMode) addMeasurePoint(marker.getLatLng());
                    });
                    
                    markerGroup.addLayer(marker);
                    markers.push({ marker, data: row });
                }
            });
            updateCount();
        }
    });
}

// Atualizar contagem de pontos
function updateCount() {
    markers.forEach(m => {
        m.marker.options.isSelected = false;
        m.marker.setIcon(createDotIcon(map.getZoom()));
    });

    if (circles.length === 0) {
        document.getElementById("count").innerText = `Pontos: ${markers.length}${measureMode ? ` | Distância Total: ${(totalDistance/1000).toFixed(2)} km` : ''}`;
        return;
    }

    let totalSelecionados = new Set();
    
    circles.forEach(circle => {
        const center = circle.getLatLng();
        const radius = circle.getRadius();
        const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius);
        
        selecionados.forEach(m => {
            m.marker.options.isSelected = true;
            m.marker.setIcon(createDotIcon(map.getZoom(), true));
            totalSelecionados.add(m.data.Nome);
        });

        updateCircleTooltip(circle);
    });

    document.getElementById("count").innerText = `Pontos selecionados: ${totalSelecionados.size} | Total: ${markers.length}${measureMode ? ` | Distância Total: ${(totalDistance/1000).toFixed(2)} km` : ''}`;
}

// Atualizar tooltip do círculo
function updateCircleTooltip(circle) {
    const center = circle.getLatLng();
    const radius = circle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius);
    
    const raioTexto = radius >= 1000 ? (radius/1000).toFixed(2) + " km" : radius.toFixed(0) + " m";
    const edgePoint = L.latLng(
        center.lat + (radius / 111320) * Math.cos(0),
        center.lng + (radius / (111320 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(0)
    );

    const tooltipOptions = {
        permanent: false,
        direction: "top",
        className: "my-tooltip",
        offset: [0, -20],
        sticky: true,
        interactive: false
    };

    if (circle.getTooltip()) {
        circle.setTooltipContent(
            `Raio: ${raioTexto}<br>Pontos: ${selecionados.length}`
        );
        circle.openTooltip(edgePoint);
    } else {
        circle.bindTooltip(
            `Raio: ${raioTexto}<br>Pontos: ${selecionados.length}`,
            tooltipOptions
        ).openTooltip(edgePoint);
    }
}

// Adicionar novo círculo
function addCircle(latlng, radius) {
    const circle = L.circle(latlng, {
        radius: radius,
        interactive: false,
        className: 'custom-circle'
    }).addTo(drawnItems);
    
    addCircleControl(circle);
    circles.push(circle);
    updateCount();
    return circle;
}

// Adicionar controle para círculo
function addCircleControl(circle) {
    document.getElementById("circleControls").style.display = "block";
    
    const circleDiv = document.createElement("div");
    circleDiv.className = "circle-control";
    circleDiv.style.margin = "5px 0";
    circleDiv.style.padding = "5px";
    circleDiv.style.borderBottom = "1px solid #eee";
    
    const center = circle.getLatLng();
    const radius = circle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius);
    
    const circleIndex = circles.length;
    
    circleDiv.innerHTML = `
        <span>Círculo ${circleIndex + 1} com ${selecionados.length} pontos</span>
        <button class="export-circle" data-id="${circleIndex}">Exportar</button>
        <button class="remove-circle" data-id="${circleIndex}">Remover</button>
    `;
    
    document.getElementById("circlesList").appendChild(circleDiv);
    
    circleDiv.querySelector(".export-circle").addEventListener("click", function() {
        exportCircleCSV(this.getAttribute("data-id"));
    });
    
    circleDiv.querySelector(".remove-circle").addEventListener("click", function() {
        removeCircle(parseInt(this.getAttribute("data-id")));
    });
}

// Remover círculo
function removeCircle(id) {
    if (id >= 0 && id < circles.length) {
        drawnItems.removeLayer(circles[id]);
        circles.splice(id, 1);
        updateCircleControls();
        updateCount();
    }
}

// Atualizar controles dos círculos
function updateCircleControls() {
    const circlesList = document.getElementById("circlesList");
    circlesList.innerHTML = "";
    
    if (circles.length === 0) {
        document.getElementById("circleControls").style.display = "none";
        return;
    }
    
    circles.forEach((circle, index) => {
        const center = circle.getLatLng();
        const radius = circle.getRadius();
        const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius);
        
        const circleDiv = document.createElement("div");
        circleDiv.className = "circle-control";
        circleDiv.style.margin = "5px 0";
        circleDiv.style.padding = "5px";
        circleDiv.style.borderBottom = "1px solid #eee";
        
        circleDiv.innerHTML = `
            <span>Círculo ${index + 1} com ${selecionados.length} pontos</span>
            <button class="export-circle" data-id="${index}">Exportar</button>
            <button class="remove-circle" data-id="${index}">Remover</button>
        `;
        
        circlesList.appendChild(circleDiv);
        
        circleDiv.querySelector(".export-circle").addEventListener("click", function() {
            exportCircleCSV(this.getAttribute("data-id"));
        });
        
        circleDiv.querySelector(".remove-circle").addEventListener("click", function() {
            removeCircle(parseInt(this.getAttribute("data-id")));
        });
    });
}

// Exportar CSV de círculo específico
function exportCircleCSV(circleId) {
    circleId = parseInt(circleId);
    if (circleId < 0 || circleId >= circles.length) return;
    
    const circle = circles[circleId];
    const center = circle.getLatLng();
    const radius = circle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius)
                                .map(m => m.data);
    
    if (selecionados.length === 0) return alert("Nenhum ponto neste círculo.");
    
    const csv = Papa.unparse(selecionados);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pontos_circulo_${circleId + 1}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Exportar CSV de todos os círculos
function exportAllCSV() {
    if (circles.length === 0) return alert("Desenhe pelo menos um círculo primeiro!");
    
    let allSelecionados = [];
    let uniqueSelecionados = new Set();
    
    circles.forEach(circle => {
        const center = circle.getLatLng();
        const radius = circle.getRadius();
        const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius)
                                    .map(m => m.data);
        
        selecionados.forEach(item => {
            const key = `${item.Latitude},${item.Longitude}`;
            if (!uniqueSelecionados.has(key)) {
                uniqueSelecionados.add(key);
                allSelecionados.push(item);
            }
        });
    });
    
    if (allSelecionados.length === 0) return alert("Nenhum ponto nos círculos.");
    
    const csv = Papa.unparse(allSelecionados);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pontos_todos_circulos.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Adicionar ponto de medição
function addMeasurePoint(latlng) {
    if (measurePoints.length > 0) {
        const lastPoint = measurePoints[measurePoints.length - 1];
        const dist = lastPoint.distanceTo(latlng);
        totalDistance += dist;
        
        const segment = L.polyline([lastPoint, latlng], { color: 'red' }).addTo(map);
        segment.bindTooltip(`${(dist/1000).toFixed(2)} km`, 
            {permanent: true, direction: 'center', className: "my-tooltip"}).openTooltip();
    }
    
    measurePoints.push(latlng);
    
    if (tempLine) map.removeLayer(tempLine);
    if (measurePoints.length > 1) {
        tempLine = L.polyline(measurePoints, { color: 'red', weight: 2 }).addTo(map);
    }
    
    updateCount();
}

// Evento de zoom para atualizar ícones
map.on('zoomend', updateMarkerIcons);

// Botão para desenhar círculo
document.getElementById("drawCircle").addEventListener("click", () => {
    try {
        new L.Draw.Circle(map, {
            shapeOptions: {
                color: 'blue',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.2
            }
        }).enable();
    } catch (e) {
        console.error("Erro ao iniciar L.Draw.Circle:", e);
        alert("Erro ao ativar o modo de desenho de círculos. Verifique o console para detalhes.");
    }
});

// Evento ao criar forma
map.on('draw:created', function(e) {
    if (e.layerType === 'circle') {
        const circle = addCircle(e.layer.getLatLng(), e.layer.getRadius());
        drawnItems.addLayer(circle);
    }
});

// Botão medir distância
document.getElementById("measureLine").addEventListener("click", () => {
    measureMode = !measureMode;
    if (!measureMode) {
        measurePoints = [];
        totalDistance = 0;
        if (tempLine) { map.removeLayer(tempLine); tempLine = null; }
        map.eachLayer(layer => {
            if (layer instanceof L.Polyline && layer.options.color === 'red') {
                map.removeLayer(layer);
            }
        });
    }
    alert(measureMode ? "Modo de medição ativado. Clique nos marcadores." : "Modo de medição desativado.");
    updateCount();
});

// Botão limpar tudo
document.getElementById("clearAll").addEventListener("click", () => {
    markerGroup.clearLayers();
    circles.forEach(circle => drawnItems.removeLayer(circle));
    circles = [];
    if (tempLine) { map.removeLayer(tempLine); tempLine = null; }
    totalDistance = 0;
    measurePoints = [];
    measureMode = false;
    map.eachLayer(layer => {
        if (layer instanceof L.Polyline && layer.options.color === 'red') {
            map.removeLayer(layer);
        }
    });
    document.getElementById("circleControls").style.display = "none";
    document.getElementById("circlesList").innerHTML = "";
    loadData(document.getElementById("filter").value);
});

// Botão exportar todos os círculos
document.getElementById("exportAllCSV").addEventListener("click", exportAllCSV);

// Evento filtro
document.getElementById("filter").addEventListener("change", function() {
    loadData(this.value);
});

// Fechar popups ao clicar no mapa
map.on('click', function() {
    map.closePopup();
});

// Carrega dados inicialmente
loadData();
</script>
</body>
</html>
