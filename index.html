<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa Interativo com Google Sheets</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<style>
  #map { height: 100vh; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

<script>
const SHEET_ID = "dados_prime"; // Substituir pelo ID real da planilha
const SHEET_URL = `https://docs.google.com/spreadsheets/d/dados_prime/gviz/tq?tqx=out:csv`;

const map = L.map('map').setView([-23.55052, -46.633308], 5);

// Adiciona mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

let markers = [];

// Função para carregar dados
Papa.parse(SHEET_URL, {
    download: true,
    header: true,
    complete: function(results) {
        results.data.forEach(row => {
            if(row.Latitude && row.Longitude) {
                const marker = L.marker([parseFloat(row.Latitude), parseFloat(row.Longitude)])
                    .bindPopup(`<b>${row.Nome}</b><br>${row.InfoExtra}`)
                    .addTo(map);
                markers.push(marker);
            }
        });
    }
});

// Controle de desenho
const drawControl = new L.Control.Draw({
    draw: {
        marker: false,
        polygon: false,
        polyline: false,
        rectangle: false,
        circle: true,  // habilita raio
        circlemarker: false
    },
    edit: {
        featureGroup: new L.FeatureGroup().addTo(map)
    }
});
map.addControl(drawControl);

// Evento ao desenhar
map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    if (e.layerType === 'circle') {
        const center = layer.getLatLng();
        const radius = layer.getRadius();

        // Seleciona marcadores dentro do raio
        let selecionados = markers.filter(m => {
            return center.distanceTo(m.getLatLng()) <= radius;
        });

        // Mostra resultado
        let lista = selecionados.map(m => m.getPopup().getContent()).join("<hr>");
        layer.bindPopup(`<b>Pontos no raio:</b><br>${lista}`).openPopup();
    }
    layer.addTo(map);
});
</script>

</body>
</html>
