<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mapa com Raio e Medição</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; }
    .control-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .small-purple-dot {
      background: purple;
      border-radius: 50%;
      width: 10px;
      height: 10px;
      border: 2px solid white;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="control-buttons">
  <button id="drawRadius">Desenhar Raio</button>
  <button id="drawLine">Medição de Distância</button>
  <button id="clearAll">Limpar Tudo</button>
  <button id="exportCSV">Exportar CSV (Raio)</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
// Inicializa mapa
const map = L.map('map').setView([-3.4653, -62.2159], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Variáveis globais
let markers = [];
let radiusCircle = null;
let centerMarker = null;
let distanceMarkers = [];
let distanceLine = null;
let totalDistance = 0;
let selectedPointsInRadius = [];

// Função para carregar dados da planilha Google
function loadGoogleSheetData() {
  const sheetID = "1_fuH8vWVLWqYb3H3PD6OB7iNuq_gT_s5wOEb01POuaw";
  const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv`;
  
  Papa.parse(sheetURL, {
    download: true,
    header: true,
    complete: function(results) {
      results.data.forEach(row => {
        if(row.lat && row.lng) {
          const marker = L.marker([parseFloat(row.lat), parseFloat(row.lng)])
            .on('click', () => {
              marker.bindPopup(`<b>${row.nome || 'Sem nome'}</b>`).openPopup();
            })
            .addTo(map);
          markers.push({ marker, data: row });
        }
      });
    }
  });
}

// Botão: Desenhar Raio
document.getElementById('drawRadius').addEventListener('click', () => {
  map.once('click', function(e) {
    const center = e.latlng;
    const radius = prompt("Digite o raio em metros:", 500);
    if(!radius) return;

    if(radiusCircle) {
      map.removeLayer(radiusCircle);
      map.removeLayer(centerMarker);
    }

    radiusCircle = L.circle(center, { radius: parseFloat(radius), color: 'blue', fillColor: 'blue', fillOpacity: 0.2 }).addTo(map);

    centerMarker = L.marker(center, {
      icon: L.divIcon({ className: 'small-purple-dot' })
    }).addTo(map);

    // Selecionar pontos dentro do raio
    selectedPointsInRadius = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius);

    radiusCircle.on('click', () => {
      const tooltipLatLng = L.latLng(center.lat, center.lng + 0.0008);
      const tooltip = L.tooltip()
        .setLatLng(tooltipLatLng)
        .setContent(`Raio: ${radius} m<br>Pontos: ${selectedPointsInRadius.length}`)
        .addTo(map);

      setTimeout(() => map.removeLayer(tooltip), 3000);
    });
  });
});

// Botão: Medir Distância
document.getElementById('drawLine').addEventListener('click', () => {
  distanceMarkers = [];
  totalDistance = 0;
  map.on('click', addDistanceMarker);
});

function addDistanceMarker(e) {
  const marker = L.marker(e.latlng).addTo(map);
  distanceMarkers.push(marker);

  if(distanceMarkers.length > 1) {
    const last = distanceMarkers[distanceMarkers.length - 2].getLatLng();
    const curr = e.latlng;
    const segmentDistance = last.distanceTo(curr);
    totalDistance += segmentDistance;

    if(distanceLine) map.removeLayer(distanceLine);
    const linePoints = distanceMarkers.map(m => m.getLatLng());
    distanceLine = L.polyline(linePoints, { color: 'red' }).addTo(map);

    const midLat = (last.lat + curr.lat) / 2;
    const midLng = (last.lng + curr.lng) / 2;
    L.marker([midLat, midLng], {
      icon: L.divIcon({ className: 'distance-label', html: `${segmentDistance.toFixed(1)} m` })
    }).addTo(map);
  }
}

// Botão: Limpar Tudo
document.getElementById('clearAll').addEventListener('click', () => {
  if(radiusCircle) map.removeLayer(radiusCircle);
  if(centerMarker) map.removeLayer(centerMarker);
  if(distanceLine) map.removeLayer(distanceLine);
  distanceMarkers.forEach(m => map.removeLayer(m));
  distanceMarkers = [];
  totalDistance = 0;
});

// Botão: Exportar CSV
document.getElementById('exportCSV').addEventListener('click', () => {
  if(selectedPointsInRadius.length === 0) {
    alert("Nenhum ponto selecionado no raio.");
    return;
  }
  const csvData = selectedPointsInRadius.map(p => p.data);
  const csv = Papa.unparse(csvData);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pontos_no_raio.csv";
  link.click();
});

loadGoogleSheetData();
</script>

</body>
</html>
