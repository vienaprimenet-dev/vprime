<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapa Interativo Avançado</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<style>
  #map { height: 100vh; }
  .filter-box {
    position: absolute;
    top: 10px;
    left: 50px;
    z-index: 1000;
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-family: Arial, sans-serif;
    box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
  }
  .leaflet-tooltip.my-tooltip {
    background: white;
    color: black;
    border: 1px solid #333;
    font-size: 12px;
    padding: 4px;
  }
</style>
</head>
<body>

<div class="filter-box">
  <label>Filtrar por tipo:</label>
  <select id="filter">
    <option value="Todos">Todos</option>
    <option value="Cliente VIP">Cliente VIP</option>
    <option value="Cliente Regular">Cliente Regular</option>
  </select>
  <button id="drawCircle">Desenhar Círculo</button>
  <button id="measureLine">Medir Distância</button>
  <button id="clearAll">Limpar Tudo</button>
  <button id="exportCSV">Exportar CSV</button>
  <span id="count"></span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1_fuH8vWVLWqYb3H3PD6OB7iNuq_gT_s5wOEb01POuaw/export?format=csv";

const map = L.map('map').setView([-23.55052, -46.633308], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let markerGroup = L.featureGroup().addTo(map);
let currentCircle = null;
let drawnItems = new L.FeatureGroup().addTo(map);
let measureMode = false;
let tempLine = null;
let measurePoints = [];
let totalDistance = 0;

// Carregar dados da planilha
function loadData(filter = "Todos") {
    markerGroup.clearLayers();
    markers = [];
    Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
            results.data.forEach(row => {
                if (row.Latitude && row.Longitude) {
                    if (filter !== "Todos" && row.InfoExtra !== filter) return;

                    const marker = L.marker([parseFloat(row.Latitude), parseFloat(row.Longitude)]);
                    marker.on('click', () => {
                        marker.bindPopup(`<b>${row.Nome}</b><br>${row.InfoExtra}`).openPopup();
                        if (measureMode) addMeasurePoint(marker.getLatLng());
                    });
                    markerGroup.addLayer(marker);
                    markers.push({ marker, data: row });
                }
            });
            updateCount();
        }
    });
}

// Atualiza contagem de pontos no raio
function updateCount() {
    if (!currentCircle) {
        document.getElementById("count").innerText = ` | Pontos: ${markers.length}`;
        return;
    }
    const center = currentCircle.getLatLng();
    const radius = currentCircle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius);
    document.getElementById("count").innerText = ` | Pontos no raio: ${selecionados.length}`;

    // Atualiza o conteúdo do tooltip (mas não o abre)
    const raioTexto = radius >= 1000 ? (radius/1000).toFixed(2) + " km" : radius.toFixed(0) + " m";
    if (currentCircle.getTooltip()) {
        currentCircle.setTooltipContent(
            `Raio: ${raioTexto}<br>Pontos: ${selecionados.length}`
        );
    }
}

// Adicionar ponto de medição
function addMeasurePoint(latlng) {
    measurePoints.push(latlng);
    if (measurePoints.length > 1) {
        const lastPoint = measurePoints[measurePoints.length - 2];
        const dist = lastPoint.distanceTo(latlng);
        totalDistance += dist;
        if (tempLine) map.removeLayer(tempLine);
        tempLine = L.polyline(measurePoints, { color: 'red' }).addTo(map);
        const midIndex = Math.floor(measurePoints.length / 2);
        const midLatLng = measurePoints[midIndex];
        tempLine.bindTooltip(`Distância total: ${(totalDistance/1000).toFixed(2)} km`, 
            {permanent: true, direction: 'center', className: "my-tooltip"}).openTooltip();
    }
}

// Botão para desenhar círculo
document.getElementById("drawCircle").addEventListener("click", () => {
    new L.Draw.Circle(map, { shapeOptions: { color: 'blue' } }).enable();
});

// Evento ao criar círculo
map.on(L.Draw.Event.CREATED, function(e) {
    if (e.layerType === 'circle') {
        if (currentCircle) map.removeLayer(currentCircle);
        currentCircle = e.layer;
        map.addLayer(currentCircle);
        
        // Configura o tooltip (sem permanent: true)
        const raioTexto = currentCircle.getRadius() >= 1000 
            ? (currentCircle.getRadius()/1000).toFixed(2) + " km" 
            : currentCircle.getRadius().toFixed(0) + " m";
        
        currentCircle.bindTooltip(
            `Raio: ${raioTexto}<br>Pontos: ${markers.length}`,
            { permanent: false, direction: "top", className: "my-tooltip" }
        );
        
        // Evento de clique para mostrar o tooltip
        currentCircle.on('click', function(e) {
            updateCount();
            currentCircle.openTooltip(e.latlng);
        });
        
        updateCount();
    }
});

// Botão medir distância
document.getElementById("measureLine").addEventListener("click", () => {
    measureMode = !measureMode;
    measurePoints = [];
    totalDistance = 0;
    if (tempLine) { map.removeLayer(tempLine); tempLine = null; }
    alert(measureMode ? "Modo de medição ativado. Clique nos marcadores." : "Modo de medição desativado.");
});

// Botão limpar tudo
document.getElementById("clearAll").addEventListener("click", () => {
    markerGroup.clearLayers();
    if (currentCircle) { map.removeLayer(currentCircle); currentCircle = null; }
    if (tempLine) { map.removeLayer(tempLine); tempLine = null; }
    totalDistance = 0;
    measurePoints = [];
    loadData(document.getElementById("filter").value);
});

// Exportar CSV dos pontos dentro do raio
document.getElementById("exportCSV").addEventListener("click", () => {
    if (!currentCircle) return alert("Desenhe um círculo primeiro!");
    const center = currentCircle.getLatLng();
    const radius = currentCircle.getRadius();
    const selecionados = markers.filter(m => center.distanceTo(m.marker.getLatLng()) <= radius)
                                .map(m => m.data);
    if (selecionados.length === 0) return alert("Nenhum ponto no raio.");
    const csv = Papa.unparse(selecionados);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pontos_raio.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});

// Evento filtro
document.getElementById("filter").addEventListener("change", function() {
    loadData(this.value);
});

// Carrega dados inicialmente
loadData();
</script>

</body>
</html>
